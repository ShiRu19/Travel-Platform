<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>

    <!-- Bootstrap 4 -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <link href="css/Chatroom.css" rel="stylesheet" />
</head>
<body>
    <h1>即時聊天範例</h1>

    <div class="row">
        <div class="col-8">
            <h4>輸入房間 ID: </h4>
            <input type="text" id="room-id" />
            <input type="button" id="join-btn" value="加入" />
            <input type="button" id="check-users-btn" value="確認人數" />
        </div>
    </div>

    <!--<div class="row mt-3">
        <div class="col-12">
            <h3>聊天內容</h3>
            <ul class="list-group" id="Content">
            </ul>
        </div>
        <div>

        </div>
    </div>-->

    <div class="row chat-box" id="container">
        <div class="col-md-6 offset-md-3">
            <div class="card" id="chatroom">
                <h3>聊天室</h3>
                <div class="chatroomContent-container">
                    <div class="row m-4" id="chatroomContent">
                        <!--<div class="col-md-12">
                            <h4>
                                <span class="badge badge-light badge-pill">Hello</span>
                            </h4>
                        </div>
                        <div class="col-md-12 text-right">
                            <h4>
                                <span class="badge badge-light badge-pill">Hi</span>
                            </h4>
                        </div>-->
                    </div>
                </div>
                <div class="row p-3">
                    <div class="col-md-12">
                        <div class="input-group">
                            <input type="text" id="inputMsg" class="form-control">
                            <div class="input-group-prepend">
                                <button type="button" id="sendButton" class="btn btn-success">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-4">
        <h4>連線 Room ID 列表</h4>
        <ul class="list-group" id="IDList-room">
        </ul>
    </div>

    <div class="col-4">
        <h4>連線 User ID 列表</h4>
        <ul class="list-group" id="IDList-user">
        </ul>
    </div>

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="/lib/microsoft/signalr/dist/browser/signalr.js"></script>
    <script>
        var connection = new signalR.HubConnectionBuilder().withUrl("/hubs/ChatHub").build();

        var roomId = "";
        var userId = "";

        // 與 Server 建立連線
        connection.start().then(function () {
            console.log("Hub 連線完成");
        }).catch(function (err) {
            alert('連線錯誤: ' + err.toString());
        });

        // 加入聊天室
        $("#join-btn").on("click", function () {
            let room_id = $("#room-id").val();
            connection.invoke("JoinGroup", room_id).catch(function (err) {
                alert('無法加入: ' + err.toString());
            });
        });

        //傳送訊息
        $('#sendButton').on('click', function () {
            var msg = $("#inputMsg").val();
            connection.invoke("SendMessage", roomId, userId, msg).catch(function (err) {
                alert('傳送錯誤: ' + err.toString());
            });
        });

        // 更新連線 Room ID
        connection.on("YourRoomID", function (id) {
            roomId = id;
        });

        // 更新連線 User ID
        connection.on("YourUserID", function (id) {
            userId = id;
        });

        // 更新連線 Room ID 列表事件
        connection.on("UpdRooms", function (jsonList) {
            var list = JSON.parse(jsonList);
            $("#IDList-room li").remove();
            for (i = 0; i < list.length; i++) {
                $("#IDList-room").append($("<li></li>").attr("class", "list-group-item").text(list[i]));
            }
        });

        // 更新連線 User ID 列表事件
        connection.on("UpdUsers", function (jsonList) {
            var list = JSON.parse(jsonList);
            $("#IDList-user li").remove();
            for (i = 0; i < list.length; i++) {
                $("#IDList-user").append($("<li></li>").attr("class", "list-group-item").text(list[i]));
            }
        });

        // 更新各房間人數
        connection.on("UpdUserCount", function (jsonList) {
            console.log(jsonList);
        });

        // 更新聊天內容事件
        connection.on("UpdContent", function (userId, msg) {
            var item_left = `<div class="col-md-12">
                            <h4>
                                <p>${userId}</p>
                                <span class="badge badge-light badge-pill">${msg}</span>
                            </h4>
                        </div>`;

            $("#chatroomContent").append(item_left);
        });
    </script>
</body>
</html>